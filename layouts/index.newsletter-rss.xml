{{- $newsletters := .Site.Data.newsletters -}}
{{- $sorted_newsletters := slice -}}

{{- range $key, $newsletter := $newsletters -}}
  {{- $sorted_newsletters = $sorted_newsletters | append $newsletter -}}
{{- end -}}

{{- $sorted_newsletters = sort $sorted_newsletters "date" "desc" -}}

<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:content="http://purl.org/rss/1.0/modules/content/">
    
  <channel>
    <title>Patoarchitekci Summer Newsletter Mail 🌞🏖️</title>
    <description>Wakacyjny newsletter z ciekawymi linkami od Łukasza i Szymona</description>
    <link>{{ .Site.BaseURL }}/newsletter</link>
    <atom:link href="{{ .Site.BaseURL }}/newsletter.xml" rel="self" type="application/rss+xml" />
    <lastBuildDate>{{ now.Format "Mon, 02 Jan 2006 15:04:05 MST" }}</lastBuildDate>
    <language>pl-PL</language>
    
    {{- range $sorted_newsletters -}}
    {{- $newsletter := . -}}
    <item>
      <title>{{ .title | htmlEscape }}</title>
      <link>{{ $.Site.BaseURL }}/newsletter/{{ .id }}/</link>
      <guid isPermaLink="true">{{ $.Site.BaseURL }}/newsletter/{{ .id }}/</guid>
      <pubDate>{{ .datetime | dateFormat "Mon, 02 Jan 2006 15:04:05 MST" }}</pubDate>
      
      <description><![CDATA[
        {{ .intro | markdownify | truncate 200 }}
      ]]></description>
      
      <content:encoded><![CDATA[
        {{ .intro | markdownify }}
        
        {{- range $person := .link_order -}}
        {{- with $newsletter.links -}}
        {{- $link := index . $person -}}
        {{- if $link -}}
        <h2>{{ if eq $person "lukasz" }}Łukasz{{ else }}Szymon{{ end }}: 
            <a href="{{ $link.url }}">{{ $link.name }}</a></h2>
        
        {{- if $link.image -}}
        <img src="{{ $.Site.BaseURL }}{{ $link.image }}" alt="{{ $link.name }}" />
        {{- end -}}
        
        {{ $link.comment | markdownify }}
        {{- end -}}
        {{- end -}}
        {{- end -}}
        
        {{- if .recommended_episode -}}
        <h2>📻 Polecany odcinek: #{{ .recommended_episode.number }} {{ .recommended_episode.title }}</h2>
        {{ .recommended_episode.description | markdownify }}
        {{- end -}}
      ]]></content:encoded>
    </item>
    {{- end -}}
  </channel>
</rss>