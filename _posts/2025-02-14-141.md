---
layout: post
title: '#141 Prosto i praktycznie wyjaÅ›niamy: Kontenery'
date: 2025-02-14 08:00:00 +0200
description: 
episode: "141"
tags: []
spreaker: 64354315
apple: https://podcasts.apple.com/pl/podcast/prosto-i-praktycznie-wyja%C5%9Bniamy-kontenery/id1477067604?i=1000692160501&uo=4
newsletter: |
  CzeÅ›Ä‡! ğŸ‘‹ âœ¨


  "**Prosto i praktycznie**" to nie Å¼art - tym razem _Patoarchitekci_ naprawdÄ™ tÅ‚umaczÄ… kontenery bez zbÄ™dnego teoretyzowania. Od **chroota** przez **FreeBSD Jail** aÅ¼ po wspÃ³Å‚czesnego **Dockera**.
  
  Poznaj anatomiÄ™ kontenerÃ³w i ich warstwowÄ… naturÄ™. Dowiedz siÄ™, jak **ContainerD** i **runc** wspÃ³Å‚pracujÄ… z kernelem, oraz dlaczego **cgroups** i **namespaces** sÄ… kluczowe dla izolacji procesÃ³w.
  
  MÄ™czysz siÄ™ z kontenerami? Daj spokÃ³j teoriom spiskowym i posÅ‚uchaj, jak to naprawdÄ™ dziaÅ‚a. **Docker build** i **docker run** nie bÄ™dÄ… juÅ¼ twoimi wrogami - obiecujemy!
  


  Åukasz wspÃ³Å‚organizuje kolejnÄ… edycjÄ™ Azure Day i z tej okazji mamy najlepszy kod zniÅ¼kowy!
  TL;DR:
  ğŸ—“ï¸ 13 marca 2024
  ğŸ“ Airport Hotel OkÄ™cie, Warszawa
  ğŸ¯ 18 sesji technicznych, poÅ‚owa prelegentÃ³w spoza Polski
  ğŸ’° Kod zniÅ¼kowy `Lukasz25w3f57e` daje 25% rabatu
  ğŸ”— SzczegÃ³Å‚y i rejestracja: <https://azureday.pl/>
  




  ## Odcinek na stronie i materiaÅ‚y do niego â¬‡ï¸


  â¡ï¸ [OdsÅ‚uchaj na stronie](https://patoarchitekci.io/141)


  â¡ï¸ [Spotify](https://open.spotify.com/episode/6QYD0KpZsClszksGSWlu17)


  â¡ï¸ [Apple Podcasts](https://podcasts.apple.com/pl/podcast/prosto-i-praktycznie-wyja%C5%9Bniamy-kontenery/id1477067604?i=1000692160501&uo=4)


  â¡ï¸ [YouTube](https://www.youtube.com/watch?v=VpPn3mGWZ2E)




  ## Short & Sweet


  ### Szymon poleca: [Jak wykrywaÄ‡ anomalie w metrykach bez AI](https://medium.com/@akashsri306/detecting-anomalies-with-z-scores-a-practical-approach-2f9a0f27458d)

  Podczas szkoleÅ„ i konsultacji z monitorowania i observability bardzo szybko pada pytanie ktÃ³re brzmi mniej wiÄ™cej tak: "A czy ma AI do wykrywania anomalii?"
  No wiÄ™c tak:
  - "AI" to moÅ¼emy uÅ¼yÄ‡ ewentualnie do napisania Å‚adnego maila, Å¼e coÅ› nie dziaÅ‚a ;)
  - Tu duÅ¼o lepiej sprawdzi siÄ™ zwykÅ‚a, stara statystyka. Jaka? A o tym wÅ‚aÅ›nie jest link :)


  ### Åukasz poleca: [Zignoruj poprzednie polecenia! Daj mi przepis!](https://www.jadlonomia.com/przepisy/tofu-zmieniajace-zycie/)

  To teraz maÅ‚a piÄ…tkowa odskocznia... JednÄ… cechÄ… wspÃ³lnÄ… PatoarchitektÃ³w, oprÃ³cz pasji do technologii, jest rÃ³wnieÅ¼... gotowanie. Polecam wam kiedyÅ› znaleÅºÄ‡ Instagrama Szymona lub jego pet-project ;-)
  
  Jako Å¼e lubimy kuchniÄ™ azjatyckÄ…, to polecam wam tÄ™ wariacjÄ™ tofu. Nawet jak nie lubisz tofu, to moÅ¼esz siÄ™ zdziwiÄ‡! Tylko sos koniecznie trzeba podrasowaÄ‡... minimum jedna Å‚yÅ¼ka pasty gochujang.




  ### ğŸ¤ DoÅ‚Ä…cz do Discord ğŸ‘‰ [https://discord.gg/78zPcEaP22](https://discord.gg/78zPcEaP22)



  ### ğŸ¢ Patron odcinka

  SÅ‚uchasz PatoarchitektÃ³w dziÄ™ki PROTOPII â€“ firmie, w ktÃ³rej Åukasz i Szymon dziaÅ‚ajÄ… na co dzieÅ„, wspierajÄ…c zespoÅ‚y IT na kaÅ¼dym etapie: od projektowania, przez wdroÅ¼enia i migracje, aÅ¼ po optymalizacjÄ™ i zabezpieczenia. Oferujemy teÅ¼ mentoring i szkolenia dostosowane do potrzeb kaÅ¼dej firmy, niezaleÅ¼nie od wielkoÅ›ci. SprawdÅº nas: [protopia.tech](https://protopia.tech/)


  PS. Masz pytania? Pisz Å›miaÅ‚o po drugiej stronie to nie bot na bazie GPT czy Claude ğŸ˜

---
"**Prosto i praktycznie**" to nie Å¼art - tym razem _Patoarchitekci_ naprawdÄ™ tÅ‚umaczÄ… kontenery bez zbÄ™dnego teoretyzowania. Od **chroota** przez **FreeBSD Jail** aÅ¼ po wspÃ³Å‚czesnego **Dockera**.

Poznaj anatomiÄ™ kontenerÃ³w i ich warstwowÄ… naturÄ™. Dowiedz siÄ™, jak **ContainerD** i **runc** wspÃ³Å‚pracujÄ… z kernelem, oraz dlaczego **cgroups** i **namespaces** sÄ… kluczowe dla izolacji procesÃ³w.

MÄ™czysz siÄ™ z kontenerami? Daj spokÃ³j teoriom spiskowym i posÅ‚uchaj, jak to naprawdÄ™ dziaÅ‚a. **Docker build** i **docker run** nie bÄ™dÄ… juÅ¼ twoimi wrogami - obiecujemy!


SÅ‚uchasz PatoarchitektÃ³w dziÄ™ki PROTOPII â€“ firmie, w ktÃ³rej Åukasz i Szymon dziaÅ‚ajÄ… na co dzieÅ„, wspierajÄ…c zespoÅ‚y IT na kaÅ¼dym etapie: od projektowania, przez wdroÅ¼enia i migracje, aÅ¼ po optymalizacjÄ™ i zabezpieczenia. Oferujemy teÅ¼ mentoring i szkolenia dostosowane do potrzeb kaÅ¼dej firmy, niezaleÅ¼nie od wielkoÅ›ci. SprawdÅº nas: [protopia.tech](https://protopia.tech/)

Discord ğŸ‘‰ [https://discord.gg/78zPcEaP22](https://discord.gg/78zPcEaP22)

Linki i ciekawe znaleziska:

- [The History of Containers](https://www.redhat.com/en/blog/history-containers)
- [Chapter 17. Jails and Containers  ](https://www.freebsd.org/doc/handbook/jails.html)
- [Namespaces in operation, part 1: namespaces overview [LWN.net]](https://lwn.net/Articles/531114/)
- [cgroups](https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt)
- [Open Container Initiative - Open Container Initiative](https://opencontainers.org/)
- [Container Runtime Interface nullCRI)  ](https://kubernetes.io/docs/concepts/architecture/cri/)
- [BuildKit](https://docs.docker.com/build/buildkit/)
- [Run your own container without Docker](https://medium.com/@alexander.murylev/run-your-own-container-without-docker-60c297faf010)
- [Something Missed? : History of Container Technology](https://oziie.medium.com/something-missed-history-of-container-technology-e978f202464a)
- [Building containers without Docker](https://blog.alexellis.io/building-containers-without-docker/)
- [A Brief History of Containers: From the 1970s Till Now](https://www.aquasec.com/blog/a-brief-history-of-containers-from-1970s-chroot-to-docker-2016/)
- [Docker for Beginners: Beyond Docker - Understanding containerd and CRI-O](https://www.iamachs.com/p/docker/part-6-understanding-containerd-and-cri-o/)

### Transkrypcja

**Åukasz KaÅ‚uÅ¼ny**: CzeÅ›Ä‡, sÅ‚uchacie PatoarchitektÃ³w. ProwadzÄ… Åukasz KaÅ‚uÅ¼ny...

**Szymon Warda**: I Szymon Warda. Wszystkie linki do odcinka Patoarchtekci.io lub gdzieÅ› na dole w opisie. Dacie radÄ™. MÄ…dre chÅ‚opaki i dziewczyny jesteÅ›cie. Dobrze. Odcinek dzisiejszy z serii prosto i praktycznie wyjaÅ›niamy, zawdziÄ™czamy...

**Åukasz KaÅ‚uÅ¼ny**: Radkowi na Discordzie i tematowi, ktÃ³ry nazwaÅ‚ "Kontenery to nie tylko Docker".

**Szymon Warda**: No wybitnie nie tylko Docker, wybitnie.

**Åukasz KaÅ‚uÅ¼ny**: I dzisiaj chyba rozbijemy to sobie na, te wyjaÅ›nienie kontenerÃ³w, rozbijemy sobie na dwa odcinki. DziÅ› zajmiemy siÄ™ stosem technologicznym, co tam dziaÅ‚a bez wchodzenia w konkretne... MoÅ¼e inaczej, tam gdzie siÄ™ to da, bez wchodzenia w konkretne projekty, bo Docker rozpoczÄ…Å‚ caÅ‚y duÅ¼y ekosystem. A w ktÃ³rymÅ› kolejnym odcinku wyjaÅ›nimy sobie o co chodzi z tym ekosystemem juÅ¼ dokÅ‚adnie i co tam siÄ™ znajduje, bo jest tego za duÅ¼o w niektÃ³rych miejscach jeÅ¼eli popatrzymy, chociaÅ¼ wszyscy nie wiedzÄ…c uÅ¼ywajÄ… tylko jedynej sÅ‚usznej linii.

**Szymon Warda**: Czyli dzisiaj jak dziaÅ‚a, a kolejny odcinek bÄ™dzie gdzie to uruchomiÄ‡.

**Åukasz KaÅ‚uÅ¼ny**: Dobra i chyba zaczniemy od historii w ogÃ³le konteneryzacji, bo technicznie jak popatrzymy, to caÅ‚e IT jest stare jak Å›wiat i my tylko odkurzamy nowe koncepty, budujÄ…c w nowy sposÃ³b kolejne elementy.

**Szymon Warda**: BudujÄ…c, korzystajÄ…c z nowych narzÄ™dzi, ewentualnie budujemy jedne rzeczy na bazie kolejnych rzeczy.

**Åukasz KaÅ‚uÅ¼ny**: Koncepcji, algorytmÃ³w. I teraz tak. ZaczÄ™Å‚o siÄ™ to wszystko w 1979 roku od chroota w Unixie w wersji 7. I to byÅ‚a pierwsza taka rzecz, jeÅ¼eli chodzi o konteneryzacjÄ™. PolegaÅ‚o to na tym, Å¼e komenda chroot pozwalaÅ‚a procesowi, ktÃ³ry startowaÅ‚, wyizolowaÄ‡ system, Å¼eby nie widziaÅ‚ caÅ‚ego file systemu. Czyli mÃ³wimy, Å¼e np. jakaÅ› tam binarka ma widzieÄ‡ tylko coÅ› od Å›cieÅ¼ki np. var/run/nazwa\_procesu powiedzmy sobie w Linuksie. Czyli technologia, taka pierwsza podstawowa technologia izolacji. No i co, idziemy spaÄ‡ na 20 lat.

**Szymon Warda**: DokÅ‚adnie tak, bo 2000 rok FreeBSD Jail, czyli rozszerzamy trochÄ™ i w tym momencie nie tylko system plikÃ³w, ale teÅ¼ dorzucamy izolacje procesÃ³w sieci i uÅ¼ytkownikÃ³w, czyli prawie wszystko co potrzebujemy i tworzymy takie wiÄ™zienie, z ktÃ³rego aplikacja sobie nie moÅ¼e wyjÅ›Ä‡. No i to oczywiÅ›cie czemu? No bo hosting nagle wchodzi nam. Wchodzi nam to, Å¼e na jednym serwerze nie trzymamy tylko jednej usÅ‚ugi, tylko tych usÅ‚ug zaczyna byÄ‡ duÅ¼o i to zaczyna mieÄ‡ sens typowo ekonomiczny.

**Åukasz KaÅ‚uÅ¼ny**: Tak, zaczynamy ruch internetowy, jeÅ¼eli popatrzycie na to, .com, moÅ¼na siÄ™ poÅ›miaÄ‡ z tego.

**Szymon Warda**: JuÅ¼ ruszyÅ‚o siÄ™ szybko.

**Åukasz KaÅ‚uÅ¼ny**: Tak i wchodzimy tutaj, jeÅ¼eli teraz popatrzymy, to sÄ… dwie rzeczy, ktÃ³re siÄ™ dziejÄ…. Pierwsza, jeÅ¼eli pÃ³jdziemy, to jest to, co siÄ™ dzieje zaraz po tym od strony Linuxa, czyli IBM wprowadza w kernelu, to bÄ™dzie 2.4.19 bodajÅ¼e, wprowadza technologiÄ™ namespace'Ã³w, ktÃ³re pozwalajÄ… wydzielaÄ‡ osobne przestrzenie nazw dla procesÃ³w. Czyli tak jak mieliÅ›my chroota i izolacjÄ™, pozwalajÄ… wydzielaÄ‡ takie osobne rzeczy. No i Szymon potem zaczyna siÄ™ teÅ¼ w innych produktach, zaczynajÄ… siÄ™ dziaÄ‡ troszeczkÄ™ inne rzeczy, ktÃ³re sÄ….

**Szymon Warda**: Potem dziaÅ‚y siÄ™... W ogÃ³le ciekawe, ile osÃ³b kojarz Solarisa tak naprawdÄ™, bo ten system istniaÅ‚ jak jeszcze byÅ‚em na studiach, a teraz juÅ¼ nie za bardzo, ale wcale siÄ™ dziaÅ‚o duÅ¼o ciekawych rzeczy, bo Solaris Container Zones, czyli wiadomo Sun Microsystems, Solaris w wersji 10. I on zapewnia takÄ… kompletnÄ… izolacjÄ™ procesÃ³w w sieci, systemu plikÃ³w, itd. i dzielimy to faktycznie, Å‚adnie sobie wirtualizujemy. Potem to siÄ™ kawaÅ‚ek jeszcze rozwinÄ™Å‚o w formie Open VS. I w tym momencie mamy implementacjÄ™ kontenerÃ³w juÅ¼ w Linuxie tak naprawdÄ™. I nam to wchodzi, Å‚adnie zaczyna dziaÅ‚aÄ‡ i mamy tÄ… izolacjÄ™ juÅ¼ na poziomie kernela.

**Åukasz KaÅ‚uÅ¼ny**: Tak. I potem pojawia siÄ™ jedna rzecz, ktÃ³ra tworzy ostatniÄ… waÅ¼nÄ… podwalinÄ™ dla tego co znamy jako kontenery, czyli Control Groupsy. Na poczÄ…tku to siÄ™ nazywaÅ‚o Process Container stworzone przez Google'a po to, Å¼eby limitowaÄ‡ dostÄ™p na schedulerze do zasobÃ³w w postaci CPU, pamiÄ™ci, IO-Ã³w dla grup procesÃ³w. Czyli jesteÅ›my w stanie podgrupÄ™ procesÃ³w powiedzieÄ‡, Å¼e izolujemy zasoby i nie pozwalamy przekroczyÄ‡ czegoÅ›. Czyli, Å¼e mÃ³wimy, Å¼e dany procesie moÅ¼esz mieÄ‡ tylko 10% czasu procesora np., albo 100M pamiÄ™ci.

**Szymon Warda**: Ogarniamy temat haÅ‚aÅ›liwych sÄ…siadÃ³w po prostu.

**Åukasz KaÅ‚uÅ¼ny**: Tak.

**Szymon Warda**: Dobrze. To co siÄ™ dalej dziaÅ‚o? Dalej na chwilÄ™ jeszcze sobie wracamy do rzeczy wokoÅ‚o Solarisa. Mamy LXC czy Linux Containers tak naprawdÄ™. No i co tam siÄ™ dziaÅ‚o? DziaÅ‚y siÄ™ tam caÅ‚kiem fajne rzeczy wÅ‚aÅ›nie, Å¼e poÅ‚Ä…czyÅ‚y siÄ™ CGroupsy, poÅ‚Ä…czyÅ‚y siÄ™ namespace'y i uruchamiamy to Å‚adnie sobie wyizolowane na pojedynczym hoÅ›cie. Czyli mamy caÅ‚oÅ›Ä‡.

**Åukasz KaÅ‚uÅ¼ny**: I tak, tutaj waÅ¼ne to jest wspÃ³Å‚dzielimy, po prostu moÅ¼emy odpaliÄ‡ sobie w Å‚atwy sposÃ³b kontener.

**Szymon Warda**: Tak, jeszcze tam dochodzi taka opcja, Å¼e mamy tam te grupy globalne, mamy grupy wydzielone i one mogÄ… siÄ™ ze sobÄ… komunikowaÄ‡, majÄ… czÄ™Å›Ä‡ rzeczy wspÃ³lnych, doÅ›Ä‡ sporo moÅ¼emy zrobiÄ‡ wÅ‚aÅ›nie pod hostowanie i teÅ¼ pod rzeczy enterprise'owe, Å‚adnie to ogarnÄ…Ä‡.

**Åukasz KaÅ‚uÅ¼ny**: Tak, przy czym patrzmy, to wszystko jest bardzo mocno w tym momencie, jak popatrzymy dla administratorÃ³w z brodÄ…, ktÃ³rzy siedzÄ… w piwnicy. I to jest bardzo waÅ¼ne, to sÄ… bardzo niskopoziomowe rzeczy i mechanizmy, jak o tym mÃ³wimy. I teraz sÅ‚uchajcie, 2013 rok to jest przeÅ‚om pod tytuÅ‚em Docker. I tutaj chodziÅ‚o o to, Å¼e Docker nie wymyÅ›liÅ‚ to, co jest najciekawsze, Docker nie wymyÅ›liÅ‚ nic nowego, tylko przykryÅ‚ bardzo przyjemnym command linem i API wÅ‚aÅ›nie na poczÄ…tku LXC. Czyli przykryÅ‚ Linux Container, Å¼eby w Å‚atwy sposÃ³b daÅ‚o siÄ™ stworzyÄ‡ kontener, dystrybuowaÄ‡ go i w przyjemny sposÃ³b dajÄ…c caÅ‚Ä… filozofiÄ™ narzÄ™dzi.

**Szymon Warda**: Do dystrybucji, ten obraz kontenera, ten docker image nam powstaÅ‚ i to byÅ‚o po prostu, uÅ¼ytecznoÅ›Ä‡ tego byÅ‚a lepsza niÅ¼ cokolwiek innego, co powstaÅ‚o wczeÅ›niej. I dlatego odniÃ³sÅ‚ taki niesamowity sukces.

**Åukasz KaÅ‚uÅ¼ny**: Tak, potem sÅ‚uchajcie jeszcze, jak historycznie byÅ‚y tam takie pomysÅ‚y jak od firmy Coroes, jak Rocket, w miÄ™dzyczasie byÅ‚a prÃ³ba powstania. ZginÄ™Å‚o to Å›mierciÄ… tragicznÄ…, jak kaÅ¼da taka technologia. I Docker teraz, co waÅ¼ne, w 2015 roku zaczyna siÄ™ caÅ‚a standaryzacja wokÃ³Å‚ Dockera, tego, co rozumiemy przez kontener. I w ramach Cloud Native Computing Foundation dziejÄ… siÄ™ chyba takie dwie waÅ¼ne rzeczy. Pierwsza to przekazanie ContainerD, czyli silnika, ktÃ³ry zastÄ…piÅ‚ LXC w Dockerze oraz runc, czyli sposobu odpalania, zostaÅ‚y przekazane de facto do CNCF-u. No i druga sprawa, chyba najwaÅ¼niejsza, to OCI.

**Szymon Warda**: Tak, ktÃ³re powstaÅ‚o z tego, Å¼e Kubernetes kiedyÅ› byÅ‚ mocno powiÄ…zany z Dockerem, ale chcieli siÄ™ od tego trochÄ™ uniezaleÅ¼niÄ‡, wiÄ™c powstaÅ‚o wÅ‚aÅ›nie OCI, czyli Open Container Initiative, ktÃ³re miaÅ‚o byÄ‡ takÄ… warstwÄ…, Å¼eby faktycznie tych kontenerÃ³w byÅ‚o trochÄ™ wiÄ™cej, Å¼eby byÅ‚o to ustandaryzowane. I to byÅ‚ sposÃ³b, w jaki uruchamiaÄ‡ natywne API, jak uruchamiaÄ‡ i obsÅ‚ugiwaÄ‡ kontenery z zewnÄ…trz, Å¼eby dziaÅ‚aÅ‚y, Å¼eby byÄ‡ niezaleÅ¼nym od tego, czy jest Docker, czy jest cokolwiek innego.

**Åukasz KaÅ‚uÅ¼ny**: Tak. Czyli caÅ‚e zaÅ‚oÅ¼enie to sÄ… specyfikacje.

**Szymon Warda**: Tak.

**Åukasz KaÅ‚uÅ¼ny**: JeÅ¼eli na to popatrzymy. I potem w miÄ™dzyczasie jeszcze w ramach wÅ‚aÅ›nie tego trendu kubernetesowego, bo tak patrzÄ…c siÄ™ bardziej dokÅ‚adnie, najpierw powstaje, ContainerD jest wydzielone, potem powstaje Open Container Initiative i pierwsza implementacja w postaci runc, ktÃ³re wÅ‚aÅ›nie pozwala uruchamiaÄ‡ te kontenery na namespace'ach i CGroupsach. I potem powstaje sobie w ramach Red Hata i Kubernetesa lekki runtime do kontenerÃ³w, ktÃ³ry siÄ™ nazywa CRI-O, czy w zaleÅ¼noÅ›ci jak Kubernetes Interface Open Runtime, jeÅ¼eli dobrze pamiÄ™tam nazwÄ™. I na tym koÅ„czy siÄ™ taka historia i wpadamy juÅ¼ w czasy nowoczesne sieczki caÅ‚ego ekosystemu, o ktÃ³re teÅ¼ byÅ‚o pytanie od wÅ‚aÅ›nie Marka i Radka na Discordzie.

**Szymon Warda**: Tak, znaczy Åukasz nie, jeszcze to siÄ™ koÅ„czy oczywiÅ›cie dramatem. Tym, Å¼e Kubernetes pozbywa siÄ™ Dockera, bo do tego doprowadziÅ‚o, Å¼e mieliÅ›my [niesÅ‚yszalne 00:08:57] i nagle juÅ¼ nie ma wbudowanego, tylko musieliÅ›my instalowaÄ‡ konkretny runtime. Ale do tego dojdziemy za chwilÄ™ opowiemy wÅ‚aÅ›nie, jak to w ogÃ³le zbudowaÄ‡.

**Åukasz KaÅ‚uÅ¼ny**: I sÅ‚uchajcie, zostawiamy Wam jednego linka, w tym - Run Your own container without Docker. Znajdziecie jeszcze sporo takich tutoriali. Tam jest akurat prosty, ale chodzi o to, Å¼e jest wytÅ‚umaczone w jaki sposÃ³b moÅ¼ecie z basha po prostu wchodzÄ…c w command line zbudowaÄ‡ kontener. Bo to nie ma Å¼adnej magii, tylko wszystkie technologie o ktÃ³rych powiedzieliÅ›my, czyli namespace'y, Control Groupsy pozwalajÄ… wam samodzielnie zbudowaÄ‡ ten kontener. Dobra, chyba teraz czas na miÄ™so.

**Szymon Warda**: Czyli czas odpowiedzieÄ‡ na to, jak to dziaÅ‚a po kolei? No wiÄ™c Åukaszu, Åukaszu, no to robimy sobie docker run, co siÄ™ dzieje?

**Åukasz KaÅ‚uÅ¼ny**: Dobra, jak odpalimy docker run, to tak naprawdÄ™ z perspektywy Kubernetesa, raczej Dockera nie dzieje siÄ™ za duÅ¼o, bo wysyÅ‚amy polecenie poprzez API. Docker wtedy przetwarza sobie tÄ… komendÄ™, wrzuca to do ContainerD i ContainerD sprawdza sobie przy okazji czy obraz jest dostÄ™pny. JeÅ¼eli nie ma go, to pobiera go z repozytorium.

**Szymon Warda**: To ja jeszcze doprecyzujÄ™. CLI, czyli Command Line Interface, bo to co wiele ludzi trochÄ™ nie ogarnia to jest to, Å¼e jak piszemy docker run to my nie robimy nic, tylko nasza linia poleceÅ„ przekazuje polecenie do demona, ktÃ³ry faktycznie wykonuje tÄ… caÅ‚Ä… robotÄ™, wÅ‚aÅ›nie do ContainerD i on tam zarzÄ…dza tym wszystkim tak naprawdÄ™.

**Åukasz KaÅ‚uÅ¼ny**: Docker jest nakÅ‚adkÄ… na [niesÅ‚yszalne 00:10:30] API.

**Szymon Warda**: DokÅ‚adnie tak.

**Åukasz KaÅ‚uÅ¼ny**: Dobra i potem co Szymon, co siÄ™ dzieje jak ContainerD dostaje request?

**Szymon Warda**: No i dostaje request, wiÄ™c zaczyna przygotowywaÄ‡ wszystko. Zaczyna przygotowywaÄ‡ rzeczy jak zasoby, sieci, wolumeny, tworzy nowy proces do ContainerD shima, Å¼eby to wszystko mogÅ‚o uruchomiÄ‡ i to i ten kontener D shim tworzy instancjÄ™ i odpala runc, ktÃ³ry wÅ‚aÅ›nie zajmie siÄ™ uruchomieniem tego faktycznego kontenera. No i przy okazji ContainerD teÅ¼ siedzi i monitoruje stan i zarzÄ…dza tym cyklem Å¼ycia naszego wspaniaÅ‚ego kontenera. No i teraz wchodzimy na poziom runc, czyli OCI, Open Container Initiative tego elementu wspÃ³lnego, Å¼e w teorii moÅ¼emy z Docker CLI odpaliÄ‡ nawet sobie inny kontenerek. I co on tam robi?

**Åukasz KaÅ‚uÅ¼ny**: I tak. Czyli jeszcze jedna rzecz do ContainerD shim, to jest takie miÄ™dzymordzie, czyli interfejs z procesami pomiÄ™dzy tym procesem faktycznego kontenera a ContainerD. Czyli moÅ¼emy te ContainerD teÅ¼ w teorii zrebootowaÄ‡, a kontener bÄ™dzie sobie dalej byÅ‚ uruchomiony. I wÅ‚aÅ›nie jak mÃ³wimy, juÅ¼ wchodzimy na poziom tej specki OCI i dokÅ‚adnie implementacji, ktÃ³rÄ… najczÄ™Å›ciej wykorzystujecie na co dzieÅ„, czyli runc, to on czyta tÄ… specyfikacjÄ™ naszego kontenera, ktÃ³ry chcemy uruchomiÄ‡, tego co zostaÅ‚o wyplute. NastÄ™pnie komunikuje siÄ™ wÅ‚aÅ›nie z, wysyÅ‚a sobie juÅ¼ calle do kernela, wykonuje rzeczy na API kernelowym juÅ¼. I to co siÄ™ dzieje? PrzestrzeÅ„ nazw dla naszego procesu, jeÅ¼eli ustawiliÅ›my wrzuca request, wrzuca limity na zasoby, czyli w tym wypadku CGrupy. NastÄ™pnie jeszcze jest jedna rzecz, ktÃ³rej wczeÅ›niej jeszcze nie wspominaliÅ›my i do tego dojdziemy, to przygotowuje system plikÃ³w, bo obraz kontenera to pod spodem jest system plikÃ³w, czyli tutaj OverlayFS, czyli skleja nam snapshoty w odpowiedni sposÃ³b z tych wszystkich warstw.

**Szymon Warda**: KtÃ³re robiliÅ›my w image'u.

**Åukasz KaÅ‚uÅ¼ny**: Tak. I uruchamia wtedy juÅ¼ w systemie operacyjnym, w tym sandboxie uruchamia ten gÅ‚Ã³wny proces kontenera, czyli ten pierwszy, ktÃ³ry mamy wskazany w poleceniu bÄ…dÅº domyÅ›lnie ustawiony w obrazie.

**Szymon Warda**: Jeszcze dorzucÄ™ jednÄ… maÅ‚Ä… rzecz, bo w tym momencie mÃ³wimy wÅ‚aÅ›nie co robi runc. A czemu w ogÃ³le tak powstaÅ‚o? Dlatego, Å¼e w sumie majÄ…c OCI strona takiej implementacji, trochÄ™ wyprzedzam, ktÃ³re zaÅ‚Ã³Å¼my robiÄ… to samo, tylko robiÄ… np. na mikromaszynach wirtualnych i takich innych rzeczach. WiÄ™c Å¼ebyÅ›cie wiedzieli w ogÃ³le czemu jest tam tyle tych warstw abstrakcji. No dobra, ale weÅºmy sobie to runc, co on dalej robi? To juÅ¼ powiedzieliÅ›my tak naprawdÄ™, przekÅ‚ada te wszystkie wymagania, ktÃ³re mamy w obrazie dockerowym i w samym uruchomieniu tak naprawdÄ™, przekÅ‚ada dokÅ‚adnie na co, na wywoÅ‚ania do kernela, czyli wÅ‚aÅ›nie inicjujemy procesy, sieÄ‡ i uÅ¼ytkownikÃ³w, czyli cztery podstawowe rzeczy. A potem CGroup, sami nakÅ‚adamy kontrolÄ™ na CPU, pamiÄ™Ä‡ RAM, dyski IO-y i sieÄ‡. Czyli pakujemy nasz kontener pracujÄ…cy w pudeÅ‚eczko Å‚adne.

**Åukasz KaÅ‚uÅ¼ny**: Tak. I sÅ‚uchajcie i tyle to wyglÄ…da jeÅ¼eli chodzi o Dockera. JeÅ¼eli byÅ›my przeszli, czyli tak jak robicie sobie wÅ‚aÅ›nie docker run. Jak powiedzielibyÅ›my sobie jak wyglÄ…da KubeCTL CreatePod. Ja bym tutaj zostawiÅ‚, bo wysyÅ‚amy te Å¼Ä…danie do Control Plane'u poprzez API Server. NastÄ™pnie kubelet je pobiera i przejdÅºmy do tego co siÄ™ dzieje na wÄ™Åºle, kiedy juÅ¼ faktycznie musi byÄ‡ odpalony.

**Szymon Warda**: Dobra, czyli wywoÅ‚ujemy po kolei run pod sandbox. Czyli tworzymy Å›rodowisko pod poda uruchamiamy postcontainer. Potem robimy pull image.

**Åukasz KaÅ‚uÅ¼ny**: A wÅ‚aÅ›nie, jeszcze zrobiÅ‚bym takÄ… sekundkÄ™, bo to jest najwiÄ™kszy mindfuck Szymon, jak siÄ™ tÅ‚umaczy. Bo Wy, jeÅ¼eli robicie sobie w Kubernetesie pod, to widzicie swÃ³j pod, w ramach poda widzicie swoje jakieÅ› rÃ³Å¼ne rzeczy, ktÃ³re sÄ…, czyli np. swÃ³j gÅ‚Ã³wny kontener aplikacyjny, jakieÅ› sidecary. A pod spodem jest jeszcze taki dziwolÄ…g, ktÃ³ry jest wÅ‚aÅ›nie pause container, ktÃ³ry utrzymuje, czyli pusty taki kontener z procesem, ktÃ³ry po prostu nic nie robi, jak sama nazwa mÃ³wi i utrzymuje ciÄ…gle w ruchu tÄ… gotowÄ… grupÄ™, wyizolowanÄ… caÅ‚Ä… w systemie operacyjnym, ktÃ³ra jest i utrzymuje tam fizycznie tego poda.

**Szymon Warda**: Å»eby moÅ¼na byÅ‚o Å‚atwo uruchomiÄ‡. No i co robimy? ÅšciÄ…gamy obraz. Albo nie Å›ciÄ…gamy, jeÅ¼eli on zostaÅ‚ zcache'owany na konkretnym node'dzie, co jest bardzo waÅ¼ne. Potem robimy create container, czyli przygotowujemy caÅ‚Ä… specyfikacjÄ™ OSI, to samo co byÅ›cie robili tworzÄ…c docker run i wszystkie zasoby, itd., zgodnie ze specyfikacjÄ…. Potem startujemy ten kontener przez start container, nazwa tÅ‚umaczy sama siebie. I potem container status, czyli monitorujemy co tam siÄ™ wÅ‚aÅ›ciwie w ogÃ³le zadziaÅ‚o i wysyÅ‚amy to do Control Plane'a tak naprawdÄ™.

**Åukasz KaÅ‚uÅ¼ny**: Tak, potem przez ten container runtime interface, ktÃ³ry sobie wymieniliÅ›my, fizycznie wlatuje to wÅ‚aÅ›nie np. na ContainerD czy CRI-O i jest odpalone. Wtedy juÅ¼ faktycznie np. odpala siÄ™ runc, konfigurowana jest jeszcze sieÄ‡, montowane sÄ… wolumeny, zasoby, ktÃ³re wynikajÄ… z Å¼ycia w Kubernetesie. Ale jeÅ¼eli popatrzymy na to tak faktycznie, to kubelet moÅ¼na porÃ³wnaÄ‡ do docker run. To co siÄ™ dzieje na takim kubelet'cie moÅ¼na wymieniÄ‡ wÅ‚aÅ›nie, czyli kubelet, agent Kubernetesa na tym wÄ™Åºle, odpowiada troszeczkÄ™ caÅ‚ej tej czÄ™Å›ci docker run i on wywoÅ‚uje potem te ContainerD.

**Szymon Warda**: Kubernetes tak naprawdÄ™ on wywoÅ‚uje CRI, czyli Container Runtime Interface i potem w zaleÅ¼noÅ›ci od tego, czy korzystamy wÅ‚aÅ›nie z ContainerD od Dockera czy korzystamy wÅ‚aÅ›nie z CRI-O, te polecenia sÄ… wykonywane przez rÃ³Å¼ne operacje. Finalnie to siÄ™ skoÅ„czy na tym, Å¼e tak naprawdÄ™ albo i ContainerD i CRI-O bÄ™dÄ… wykorzystywaÅ‚y wÅ‚aÅ›nie OCI, czyli Open Container Initiative, Å¼eby dalej to uruchomiÄ‡. WiÄ™c mamy parÄ™ miejsc do wymiany i to zaleÅ¼Ä… w kontekÅ›cie Kubernetesa jak i co. Ale tak, ta Å›cieÅ¼ka, jeÅ¼eli korzystamy z Docekra, jest taka sama praktycznie, tak.

**Åukasz KaÅ‚uÅ¼ny**: Å»eby zostawiÄ‡ Wam lekki mindfuck na przyszÅ‚oÅ›Ä‡, bo to teÅ¼ siÄ™ dzieje, to byÄ‡ moÅ¼e zamiast Container Runtime, zamiast ContainerD, czy jakiegoÅ› systemu do mikroVM bÄ™dziemy mieli tutaj runtime, ktÃ³ry implementuje te CRI, ale odpala nam Web Assembly w trybie serwerowym.

**Szymon Warda**: Ale sÄ… w ogÃ³le runtime'y, ktÃ³re odpalajÄ… po prostu VM-ki tak naprawdÄ™.[NiesÅ‚yszalne 00:17:05] Kubernetesa, ktÃ³ry zamiast pody sÄ… mikroVM-kami. MoÅ¼na.

**Åukasz KaÅ‚uÅ¼ny**: MoÅ¼na. Do tego jeszcze sobie przejdziemy w kolejnych odcinkach.

**Szymon Warda**: Tak, taka reklama na przyszÅ‚oÅ›Ä‡.

**Åukasz KaÅ‚uÅ¼ny**: Tak.

**Szymon Warda**: Dobrze.

**Åukasz KaÅ‚uÅ¼ny**: Dobra.

**Szymon Warda**: To Å›migamy dalej. Budowanie obrazÃ³w Åukaszu, jak to wyglÄ…da?

**Åukasz KaÅ‚uÅ¼ny**: I teraz o co chodzi? Bo powiedzieliÅ›my sobie kontener to jest, trochÄ™ jeszcze na chwilÄ™ siÄ™ cofajÄ…c, kontener dostarcza nam dwie rzeczy. Czyli odpala nam ten proces, ale rÃ³wnieÅ¼ skÄ…dÅ› musi siÄ™ wziÄ…Ä‡ nasza aplikacja i caÅ‚e te zaleÅ¼noÅ›ci z systemu operacyjnego w Å›rodku, jak i serwer aplikacyjny, nasz kod. I tu mÃ³wimy o obrazie kontenera. Jak teraz popatrzymy, to jest spakowana aplikacja, spakowany FileSystem ze wszystkimi naszymi potrzebnymi zaleÅ¼noÅ›ciami i on siÄ™ skÅ‚ada z warstw i kaÅ¼da warstwa jest read only, jest snapshotem systemu plikÃ³w. Czyli moÅ¼ecie popatrzeÄ‡ na to, jeÅ¼eli ktoÅ› z Was uÅ¼ywaÅ‚ dyskÃ³w rÃ³Å¼nicowych np. w VirtualBoxie, to jest to, czy w VMware Player Workstation, to jest po prostu taki Å‚aÅ„cuch, dysk do dysku, do obrazu, do obrazu, do obrazu, czyli taka rÃ³Å¼nicÃ³wka zbudowana, caÅ‚y chain.

**Szymon Warda**: Co czÄ™sto widzicie, jak robicie docker build, to widzicie, Å¼e niektÃ³re warstwy sÄ… faktycznie liczone, Å¼e tak powiem, a niektÃ³re sÄ… po prostu brane z cache'a i mÃ³wi, Å¼e nie bÄ™dzie tego robiÅ‚. To jest teÅ¼...

**Åukasz KaÅ‚uÅ¼ny**: Przy pobieraniu teÅ¼ widaÄ‡ wÅ‚aÅ›nie te warstwy.

**Szymon Warda**: Tak, dokÅ‚adnie. Jaka jest warstwa najniÅ¼sza? To jest ten base layer, ktÃ³ry nam wÅ‚aÅ›nie mÃ³wi o tym systemie operacyjnym, czyli co, od czego zaczynamy. Czy to bÄ™dzie Alpine, czy to bÄ™dzie Ubuntu, czy to bÄ™dzie Debianek, czy cokolwiek innego. I on jest czÄ™sto wspÃ³Å‚dzielony, przez co teÅ¼ czÄ™sto jest niepobierany, mimo Å¼e ten obraz po prostu jest duÅ¼y. Co jest dalej, Åukaszu?

**Åukasz KaÅ‚uÅ¼ny**: Czy wiesz co jeszcze bym dodaÅ‚, Å¼e podstawowa warstwa, ta taka base'owa, rozdzieliÅ‚bym jeszcze dwie rzeczy, Å¼e zazwyczaj to sÄ… jakieÅ› podstawowe procesy wokÃ³Å‚ systemu operacyjnego, podstawowe narzÄ™dzia. GÅ‚upi ls, cut, grep, dir te wszystkie komendy lub w wersji super bezpiecznej, tak zwanej distroless albo from scratch, mamy tylko bardzo podstawowe binarki bez Å¼adnego peÅ‚nego systemu operacyjnego.

**Szymon Warda**: O ile pamiÄ™tam GO tak leci w ogÃ³le wÅ‚aÅ›nie.

**Åukasz KaÅ‚uÅ¼ny**: Pozwala w Å‚atwy sposÃ³b np., tak. Ale teraz teÅ¼ .Net siÄ™ dorobiÅ‚, Java, wiÄ™c moÅ¼na lecieÄ‡. I potem mamy te Å›rodkowe warstwy. One sÄ… rÃ³wnowaÅ¼ne, technicznie one sÄ… ze sobÄ… rÃ³wnowaÅ¼ne. I tu zazwyczaj to, co robicie, to np. instalujecie pipem, npmem zaleÅ¼noÅ›ci, jakimÅ› aptem lub innym package managerem instalujecie zaleÅ¼noÅ›ci w systemie operacyjnym, wiÄ™c konfigurujecie.

**Szymon Warda**: Tak, a na koÅ„cu przykrywamy to gÃ³rnÄ… warstwÄ…, ktÃ³ra zawiera wszystkie metadane, czyli wÅ‚aÅ›nie jakie porty, jakie mamy wolumeny, jakie mamy zmienne. A na sam koniec mamy nasze ukochane cmd/entrypoint, ktÃ³ry mÃ³wi co wÅ‚aÅ›ciwie ma siÄ™ wydarzyÄ‡. Jak odpalamy ten, upraszczajÄ…c oczywiÅ›cie, docker run, to jaka komenda ma byÄ‡ uruchomiona.

**Åukasz KaÅ‚uÅ¼ny**: Tak. I potem, teraz jak popatrzymy sobie, jest docker file, ale jest rÃ³wnieÅ¼ on pod nazwÄ… container file. Czyli mamy skrypt, ktÃ³ry mÃ³wi nam jak zbudowaÄ‡ obraz. I tam sÄ… po prostu komendy, imperatywnie komenda po komendzie. Czyli weÅº mi np. obraz bazowy, weÅº mi Ubuntu i nastÄ™pnie spatchuj system, zainstaluj np. Pythona, zainstaluj jakiÅ› serwer aplikacyjny i potem wkopiowujemy. I kaÅ¼de takie polecenie, sÅ‚uchajcie, to jest oddzielnie uruchamiany tymczasowy kontener, w ktÃ³rym jest wykonywana ta komenda i po jego stworzeniu jego file system jest zipowany, oznaczony shome i jest on wÅ‚aÅ›nie tÄ… warstwÄ…. I kolejne polecenie startuje z tego poprzedniego snapshota file systemu i na nim wykonuje komendÄ™, zamyka siÄ™, aÅ¼ tak dojdziemy do samego koÅ„ca.

**Szymon Warda**: Dlatego wÅ‚aÅ›nie miÄ™dzy innymi przez komendÄ™ rozumiemy same run albo samÄ… komendÄ™ na poziomie docker file'a, nie na poziomie systemu operacyjnego. Dlatego np. endowanie, czy po prostu w jednÄ… liniÄ™ wrzucanie wielu komend opÅ‚aca siÄ™, bo w tym momencie po prostu mamy mniej tych obrazÃ³w po drodze.

**Åukasz KaÅ‚uÅ¼ny**: Tak, jeÅ¼eli popatrzycie, to technicznie bÄ™dziemy mÃ³wiÄ‡ zazwyczaj o dwÃ³ch projektach, jeÅ¼eli chodzi o budowanie. To jest uproszczenie, ale z nimi siÄ™ najczÄ™Å›ciej spotykacie. To jest buildx i buildkit, jeÅ¼eli popatrzymy tutaj. I build, jeÅ¼eli popatrzymy, buildkit to jest caÅ‚y taki toolkit od Dockera, ktÃ³ry sÅ‚uÅ¼y do budowania, pozwala nam, daje wszystkie potrzebne binarki, artefakty, Å¼eby zbudowaÄ‡ obraz. I on daje teraz takie rzeczy jak wÅ‚aÅ›nie multi-stage build, budowanie pomiÄ™dzy wieloma platformami, cashe'owanie, wspÃ³Å‚bieÅ¼ne budowanie jeÅ¼eli wyliczy sobie zaleÅ¼noÅ›ci. A buildx to jest CLI od Dockera, ktÃ³ry jest teÅ¼ w samym Dockerze, do budowania obrazu. Czyli jeÅ¼eli teraz odpalacie docker build, to tak naprawdÄ™ buildx jest odpalany pod spodem. Czyli wÅ‚aÅ›nie wczeÅ›niej to byÅ‚ plugin jako CLI, teraz po prostu buduje kontenery, to natywnie w ramach Dockera, jeÅ¼eli odpalacie.

**Szymon Warda**: DokÅ‚adnie. I jakby ktoÅ› nie kojarzyÅ‚ czym sÄ… multi-stage build, to jest ten moment, kiedy mamy osobne kroki, ktÃ³re budujÄ… i potem zawartoÅ›Ä‡ tego obrazu kopiujemy do faktycznego kontenera uruchomieniowego. I w tym kontenerze uruchomionym nie mamy juÅ¼ Å›ladu po tym kontenerze, ktÃ³ry nam budowaÅ‚. No bo trzymanie wersji zdebugowanej i z narzÄ™dziami debugowania nie jest dobrym pomysÅ‚em w obrazach.

**Åukasz KaÅ‚uÅ¼ny**: MoÅ¼na porozbijaÄ‡. I na koniec sÅ‚uchajcie, jest jeszcze waÅ¼na rzecz, czyli repozytorium tych image'y. Czyli sÅ‚uchajcie, to co jest, to te spakowane tary + manifest, czyli JSON, ktÃ³ry mÃ³wi co w danej warstwie jest i do niego metadane, wysyÅ‚amy w targi zipie pod spodem, jak popatrzycie dokÅ‚adnie. W targi zip wysyÅ‚amy do takiego repozytorium, ktÃ³re teÅ¼ ma swojÄ… specyfikacjÄ™. I to co siÄ™ dzieje wysyÅ‚amy sobie oddzielnie warstwy i w manifeÅ›cie kaÅ¼da z tych warstw ma wyliczonÄ… sumÄ™ kontrolnÄ… w sha256. Czyli z tego file systemu jest wyliczana suma kontrolna, wpychana do manifestu i my wysyÅ‚amy manifest, a nastÄ™pnie warstwy razem z ich check sumÄ….

**Szymon Warda**: Ten manifest moÅ¼emy podejrzeÄ‡ wykonujÄ…c komendÄ™ docker inspect i dostaniemy bardzo Å‚adnego JSON-a, ktÃ³ry mÃ³wi nam o wszystkim, co siÄ™ wydarzyÅ‚o w tym obrazie.

**Åukasz KaÅ‚uÅ¼ny**: Tak. I z drugiej strony moÅ¼na teÅ¼ to sobie, w zaleÅ¼noÅ›ci od tego, jakie repozytorium uÅ¼ywacie albo rejestr, w zaleÅ¼noÅ›ci jak tam, ktÃ³rej nazwy uÅ¼ywaÄ‡, czego uÅ¼ywacie do przechowywania, to teÅ¼ dajÄ… podglÄ…d na takie coÅ› zazwyczaj. Albo moÅ¼na, jako Å¼e API jest otwarte, to moÅ¼na sieknÄ…Ä‡ curlem i teÅ¼ sobie Å›ciÄ…gnÄ…Ä‡.

**Szymon Warda**: Tak. Dobra, to chyba tyle na ten odcinek, no nie?

**Åukasz KaÅ‚uÅ¼ny**: Tyle, koÅ„czymy, na razie.

**Szymon Warda**: DziÄ™ki. Hej.

